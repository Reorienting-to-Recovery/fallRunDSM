---
title: "CRR Metric for R2R"
author: "Maddee Rubenson (FlowWest)"
date: "`r Sys.Date()`"
output: 
  html_document
 # rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, 
                      message = FALSE)
library(tidyverse)
library(fallRunDSM)
library(plotly)
```

### Run fallRunDSM model

Must use [FlowWest/fallRunDSM branch crr/metrics](https://github.com/FlowWest/fallRunDSM/tree/metrics/crr) of fallRunDSM. This branch has been modified to have the necessary outputs to quantify cohort replacement rate.

```{r}
# remotes::install_github("flowwest/fallRunDSM@metrics/crr")
s <- fall_run_model(mode = "seed", ..params = fallRunDSM::r_to_r_baseline_params)
sim <- fall_run_model(seeds = s, mode = "simulate", ..params = fallRunDSM::r_to_r_baseline_params)
```

## Adult Return Ratio

**Definition:** This value represents the proportion of natural spawners created by in river spawners from three years prior.

**Calculation:** Adult return to natural origin/spawning adult ratio (mean) is defined as: the number of natural origin adult returns in year X + 3 divided by the number of in-river spawners in year X.

$natural origin adults _ (x+3) / in river spawners_x$

**Assumptions:**

-   Adults return over the course of three years with 25% returning in year X + 2, 50% returning in year X + 3, and the final 25% returning in year X + 4. For example, in year 6 adults are returning from years 2 (25%), 3 (50%), and 4 (25%). This should be considered when exploring the adult return ratio because each year's value is an aggregate of multiple years of return salmonids.

-   Values as `NA` do not have spawning

![](crr_diagram.png){width="605"}

```{r}
natural_spawners <- (sim$proportion_natural * sim$spawners) |>
  as_tibble() |>
  mutate(watershed = fallRunDSM::watershed_labels) |>
  pivot_longer(names_to = "year", values_to = "natural_spawners", -watershed)

in_river_spawners <- sim$spawners |>
  as_tibble() |>
  mutate(watershed = fallRunDSM::watershed_labels) |>
  pivot_longer(names_to = "year", values_to = "total_spawners", -watershed)

sim_spawners <- in_river_spawners |>
  left_join(natural_spawners) |>
  group_by(watershed) |>
  mutate(
    year = as.numeric(year),
    lag_total = lag(total_spawners, 3),
    origin_year = lag(year, 3),
    metric = natural_spawners / lag_total) 

adult_plot <- sim_spawners |>
  ggplot(aes(origin_year, metric)) +
  geom_line(aes(color = watershed)) +
  scale_x_continuous(breaks = 1:20) + 
  theme_minimal() + 
  ylab('Adult Return Ratio') 

# ggplotly(adult_plot)

 # theme(legend.position = "top") 
# 20 year average across all watersheds
# percents 
sim_spawners |>
  group_by(watershed) |>
  summarise(
    mean_adult_return_to_origin = mean(metric, na.rm = TRUE) * 100,
    median_adult_return_to_origin = median(metric, na.rm = TRUE) * 100
  ) |> knitr::kable(digits = 1)
```

## Juveniles to Adult Ratio

**Definition**: This ratio represents the percent of returning natural origin adults that a cohort of juveniles produces.

**Calculation**: The average juvenile to adult return ration is defined as the number of juveniles produced in year X divided by the number of natural origin adult returns in year X + 3.

$juveniles_x / natural origin adults_(x_+3)$

**Assumptions**:

-   The number of juveniles produced is assumed to be the value prior to survival and migration factors applied. TODO: Do we want to capture total juveniles prior to or after survival metrics are applied?

-   Values as `NA` do not have spawning

```{r}
juveniles <- sim$juveniles |> 
  as_tibble() |>
  mutate(year = as.numeric(year)) |>
  group_by(year, watershed) |>
  summarise(total_juveniles = sum(juveniles)) |>
  ungroup() |>
  left_join(natural_spawners |>
              mutate(year = as.numeric(year))) |>
  arrange(watershed, year) |>
  group_by(watershed) |>
  mutate(natural_spawners_lag = lead(natural_spawners, 3),
         metric = total_juveniles / natural_spawners_lag,
         metric_rev = natural_spawners_lag / total_juveniles) |>
  ungroup()

juveniles |>
  group_by(watershed) |>
  summarise(avg_juvenile_metric_perc = mean(metric_rev, na.rm = TRUE) * 100,
            median_juvenile_metric_perc = median(metric_rev, na.rm = TRUE) * 100) |>
  arrange(-avg_juvenile_metric_perc) |> 
  knitr::kable(digits = 1)

juv_plot <- juveniles |>
  ggplot(aes( year, metric_rev)) +
  geom_line(aes(color = watershed)) +
  scale_x_continuous(breaks = 1:20) +
  ylab('Juvenile to Adult Ratio') + 
  theme_minimal()

ggplotly(juv_plot)
```
